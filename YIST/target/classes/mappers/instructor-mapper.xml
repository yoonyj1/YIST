<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"mybatis-3-mapper.dtd" >

<mapper namespace="instructorMapper">

	<resultMap id="taskResultSet" type="Task">
		<result column="task_no" property="taskNo"></result>
		<result column="file_no" property="fileNo"></result>
		<result column="subject_no" property="subjectNo"></result>
		<result column="id" property="instructorId"></result>
		<result column="task_title" property="taskTitle"></result>
		<result column="task_content" property="taskContent"></result>
		<result column="start_date" property="startDate"></result>
		<result column="end_date" property="endDate"></result>
		<result column="origin_name" property="originName"></result>
		<result column="change_name" property="changeName"></result>
		<result column="file_level" property="fileLevel"></result>
		<result column="status" property="status"></result>
		
	</resultMap>
	
	<resultMap id="taskSubmitResultSet" type="TaskSubmit">
		<result column="task_no" property="taskNo"></result>
		<result column="id" property="id"></result>
		<result column="task_title" property="taskTitle"></result>
		<result column="submit_content" property="submitContent"></result>
		<result column="name" property="name"></result>
		<result column="submit_date" property="submitDate"></result>
		<result column="modify_date" property="modifyDate"></result>
		<result column="status" property="status"></result>
	</resultMap>
	
	<insert id="insertTask">
		insert
		    into task
		        (
		           task_no
		         , subject_no
		         , id
		         , task_title
		         , task_content
		         , start_date
		         , end_date
		        )
		        values
		        (
		            seq_taskno.nextval
		          , #{subjectNo}
		          , #{instructorId}
		          , #{taskTitle}
		          , #{taskContent}
		          , #{startDate}
		          , #{endDate}
		        )
	</insert>
	
	<insert id="insertTaskFile">
		insert
		    into task_file
		        (
		            file_no
		          , task_no
		          , origin_name
		          , change_name
		          , file_level
		          , status
		        )
		        values
		        (
		            seq_tfno.nextval
		          , seq_taskno.currval
		          , #{originName}
		          , #{changeName}
		          , 1
		          , 'Y'
		          )
	</insert>
	
	<select id="selectTaskListCount" resultType="_int" parameterType="Map">
		select count(task_no) as "taskListCount"
		from task
		left join task_file using (task_no)			
		where id = #{id} and status = 'Y'
		<if test="startDate != 'none'">
			and start_date between to_date(#{startDate},'RRRR-MM-DD') and to_date(#{endDate},'RRRR-MM-DD')
		</if>
		<if test="keyword != 'none'">
			and task_title like '%' || #{keyword} || '%'
		</if>
	</select>
	
	<select id="selectTaskList" resultMap="taskResultSet" parameterType="Map">
		select 
		        task_no
		      , file_no
		      , subject_no
		      , id
		      , task_title
		      , task_content
		      , to_char(start_date, 'RRRR-MM-DD') as "start_date"
		      , to_char(end_date, 'RRRR-MM-DD') as "end_date"
		      , origin_name
		      , change_name
		      , file_level
		      , status
		from task 
		left join task_file using (task_no)
		where id = #{id} and status = 'Y'
		<if test="startDate != 'none'">
			and start_date between to_date(#{startDate},'RRRR-MM-DD') and to_date(#{endDate},'RRRR-MM-DD')
		</if>
		<if test="keyword != 'none'">
			and task_title like '%'||#{keyword}||'%'
		</if>
		order by task_no desc
	</select>
	
	<update id="updateTask">
		update 
		task
		    set task_title = #{taskTitle}
		     , task_content = #{taskContent}
		   	 , start_date = to_date(#{startDate}, 'RR-MM-DD')
		 	 , end_date = to_date(#{endDate}, 'RR-MM-DD')
		where task_no = #{taskNo}
	</update>
	
	<update id="updateTaskFile">
		update
		task_file
			set origin_name = #{originName}
			  , change_name = #{changeName}
		where task_no = #{taskNo}
	</update>
	
	<update id="deleteTask">
		update
		task_file
			set status = 'N'
		where task_no = #{taskNo}
	</update>
	
	<select id="selectSubmitList" resultMap="taskSubmitResultSet">
		SELECT 
		        t.task_no as "task_no"
		      , t.task_title as "task_title"
		      , submit_content as "submit_content"
		      , name
			  , submit_date
		      , s.status as "status"
		FROM task_submit s
		join member m on (s.id = m.id)
		join task t on (s.task_no = t.task_no)
		where s.task_no = #{taskNo}
	</select>
</mapper>





















